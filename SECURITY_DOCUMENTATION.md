# üîê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: –ü–¢–°–† –≠–∫—Å–ø–µ—Ä—Ç  
**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 12 –Ω–æ—è–±—Ä—è 2025  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 12 –Ω–æ—è–±—Ä—è 2025

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#1-–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ–ª–µ–π (RBAC)](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–æ–ª–µ–π-rbac)
3. [–°–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π](#3-—Å–µ—Ä–≤–µ—Ä–Ω–∞—è-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ä–æ–ª–µ–π)
4. [–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞](#4-–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è-–ø—Ä–æ–≤–µ—Ä–∫–∞-–¥–æ—Å—Ç—É–ø–∞)
5. [Row-Level Security (RLS)](#5-row-level-security-rls)
6. [Edge Functions](#6-edge-functions---—Å–µ—Ä–≤–µ—Ä–Ω–∞—è-–ª–æ–≥–∏–∫–∞)
7. [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞](#7-–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ—Ç–æ–∫–∞-–ø—Ä–æ–≤–µ—Ä–∫–∏-–¥–æ—Å—Ç—É–ø–∞)
8. [–ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º](#8-–º–∞—Ç—Ä–∏—Ü–∞-–¥–æ—Å—Ç—É–ø–∞-–ø–æ-–æ–ø–µ—Ä–∞—Ü–∏—è–º)
9. [–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç–∞](#9-—É—è–∑–≤–∏–º–æ—Å—Ç–∏-–∏-–∑–∞—â–∏—Ç–∞)
10. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#10-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
11. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞](#11-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–¥–æ—Å—Ç—É–ø–∞)
12. [–ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#12-—á–µ–∫–ª–∏—Å—Ç-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

---

## 1. –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π (RBAC - Role-Based Access Control), —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —É—Ä–æ–≤–Ω–µ:

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** (Row-Level Security –≤ PostgreSQL)
2. **–°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** (Edge Functions —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π JWT)
3. **–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (React Router Guards)

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- ‚úÖ **Defense in Depth** - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
- ‚úÖ **Principle of Least Privilege** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞
- ‚úÖ **Secure by Default** - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ **Zero Trust Architecture** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ–ª–µ–π (RBAC)

### 2.1. –¢–∞–±–ª–∏—Ü–∞ —Ä–æ–ª–µ–π –≤ –ë–î

```sql
-- Enum –¥–ª—è —Ç–∏–ø–æ–≤ —Ä–æ–ª–µ–π
CREATE TYPE public.app_role AS ENUM (
  'admin', 
  'support', 
  'psychologist', 
  'volunteer', 
  'user'
);

-- –¢–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ä–æ–ª—å
CREATE TABLE public.user_roles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role app_role NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  UNIQUE(user_id, role)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role ON user_roles(role);
```

üîí **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ**: –†–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `user_roles`, –∞ **–ù–ï** –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞—Ç–∞–∫–∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.

### 2.2. –¢–µ–∫—É—â–∏–µ —Ä–æ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ

| –†–æ–ª—å | –ö–æ–ª-–≤–æ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|--------------|----------|
| **admin** | 1 | –ú–∏—Ö–∞–∏–ª –ó–≤–µ—Ä–µ–≤ | –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ |
| **support** | 1 | –í–∞—Å–∏–ª–∏–π –ó–≤–µ—Ä–µ–≤ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |
| **psychologist** | 1 | –¢–µ—Å—Ç –ü—Å–∏—Ö–æ–ª–æ–≥ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º, –ø—Ä–æ—Ñ–∏–ª–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∞ |
| **volunteer** | 0 | - | –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ |
| **user** | –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ | - | –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã |

### 2.3. –ò–µ—Ä–∞—Ä—Ö–∏—è –¥–æ—Å—Ç—É–ø–∞

```
admin (üëë)
‚îú‚îÄ‚îÄ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º
‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏
‚îú‚îÄ‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π

support (üõ†Ô∏è)
‚îú‚îÄ‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏
‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–µ–π
‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
‚îú‚îÄ‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω–µ–≤–Ω–∏–∫–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (–¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏)
‚îî‚îÄ‚îÄ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

psychologist (üß†)
‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º
‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
‚îú‚îÄ‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
‚îú‚îÄ‚îÄ –†–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
‚îî‚îÄ‚îÄ –î–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å–∞–º

user (üë§)
‚îú‚îÄ‚îÄ –°–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
‚îú‚îÄ‚îÄ –î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
‚îú‚îÄ‚îÄ –î–Ω–µ–≤–Ω–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤
‚îú‚îÄ‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
```

---

## 3. –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π

### 3.1. RPC —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **SECURITY DEFINER** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—Ö–æ–¥–∞ RLS:

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```sql
CREATE OR REPLACE FUNCTION public.is_admin() 
RETURNS boolean
LANGUAGE plpgsql 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  IF auth.uid() IS NULL THEN 
    RETURN FALSE; 
  END IF;
  
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ user_roles
  RETURN EXISTS (
    SELECT 1 
    FROM user_roles
    WHERE user_id = auth.uid() 
      AND role = 'admin'
  );
END;
$$;
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

```sql
CREATE OR REPLACE FUNCTION public.is_support() 
RETURNS boolean
LANGUAGE plpgsql 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  IF auth.uid() IS NULL THEN 
    RETURN FALSE; 
  END IF;
  
  RETURN EXISTS (
    SELECT 1 
    FROM user_roles
    WHERE user_id = auth.uid() 
      AND role = 'support'
  );
END;
$$;
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∞

```sql
CREATE OR REPLACE FUNCTION public.is_psychologist() 
RETURNS boolean
LANGUAGE plpgsql 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  IF auth.uid() IS NULL THEN 
    RETURN FALSE; 
  END IF;
  
  RETURN EXISTS (
    SELECT 1 
    FROM user_roles
    WHERE user_id = auth.uid() 
      AND role = 'psychologist'
  );
END;
$$;
```

#### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏

```sql
CREATE OR REPLACE FUNCTION public.has_role(_user_id uuid, _role text) 
RETURNS boolean
LANGUAGE sql 
STABLE 
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 
    FROM user_roles
    WHERE user_id = _user_id 
      AND role::text = _role
  )
$$;
```

### 3.2. –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π `auth.uid()` –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞
2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_roles`
3. –í–µ—Ä–Ω—É—Ç—å `true/false` –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π

---

## 4. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

### 4.1. AuthContext - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª**: `contexts/AuthContext.tsx`

```typescript
interface AuthContextType {
  session: Session | null;     // Supabase —Å–µ—Å—Å–∏—è
  user: User | null;            // –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  isAdmin: boolean;             // –§–ª–∞–≥ –∞–¥–º–∏–Ω–∞
  isSupport: boolean;           // –§–ª–∞–≥ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
  isPsychologist: boolean;      // –§–ª–∞–≥ –ø—Å–∏—Ö–æ–ª–æ–≥–∞
  isVolunteer: boolean;         // –§–ª–∞–≥ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞
  isLoading: boolean;           // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
  signIn: (email, password) => Promise<{error}>;
  signUp: (email, password, userData) => Promise<{error}>;
  signOut: () => Promise<void>;
  refreshRoles: () => Promise<void>;
}
```

#### –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

```typescript
1. –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ AuthProvider:
   ‚îî‚îÄ> supabase.auth.getSession()  // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
   ‚îî‚îÄ> checkUserRoles(user)         // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ RPC
       ‚îî‚îÄ> Promise.all([
           supabase.rpc('is_admin'),
           supabase.rpc('is_support'),
           supabase.rpc('is_psychologist')
         ])
       ‚îî‚îÄ> –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤

2. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
   ‚îî‚îÄ> supabase.auth.onAuthStateChange()
   ‚îî‚îÄ> checkUserRoles(newUser)
   ‚îî‚îÄ> –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
```

üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –†–æ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **—Å–µ—Ä–≤–µ—Ä–Ω—ã–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏**
- ‚úÖ –ù–∏–∫–∞–∫–æ–≥–æ localStorage/sessionStorage
- ‚úÖ JWT —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- ‚ùå –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ñ–ª–∞–≥–∏ –ù–ï —è–≤–ª—è—é—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è UI)

### 4.2. Protected Routes - –ó–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤

#### A. ProtectedRoute (–±–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)

**–§–∞–π–ª**: `components/ProtectedRoute.tsx`

```typescript
export default function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const { session, isLoading } = useAuth()
  const router = useRouter()
  const pathname = usePathname()

  useEffect(() => {
    if (!isLoading && !session) {
      router.push(`/login?from=${encodeURIComponent(pathname)}`)
    }
  }, [session, isLoading, router, pathname])

  if (isLoading) return <LoadingSpinner />
  if (!session) return null

  return <>{children}</>
}
```

**–ó–∞—â–∏—â–∞–µ—Ç**: 
- `/profile` (–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `/diary` (–¥–Ω–µ–≤–Ω–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- `/mood-diary` (–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è)

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: `session !== null`  
**–†–µ–¥–∏—Ä–µ–∫—Ç**: `/login` (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º from location)

#### B. AdminProtectedRoute

**–§–∞–π–ª**: `components/admin/AdminProtectedRoute.tsx`

```typescript
export default function AdminProtectedRoute({ children }: { children: React.ReactNode }) {
  const { session, isAdmin, isLoading } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (!isLoading && (!session || !isAdmin)) {
      router.push('/')
    }
  }, [session, isAdmin, isLoading, router])

  if (isLoading) return <LoadingSpinner />
  if (!session || !isAdmin) return null

  return <>{children}</>
}
```

**–ó–∞—â–∏—â–∞–µ—Ç**: `/admin/dashboard` (–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)  
**–ü—Ä–æ–≤–µ—Ä–∫–∞**: `isAdmin === true`  
**–†–µ–¥–∏—Ä–µ–∫—Ç**: `/` (–≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)

#### C. SupportProtectedRoute

**–§–∞–π–ª**: `components/support/SupportProtectedRoute.tsx`

**–ó–∞—â–∏—â–∞–µ—Ç**: `/support/dashboard` (–ø–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏)  
**–ü—Ä–æ–≤–µ—Ä–∫–∞**: `isSupport === true`  
**–†–µ–¥–∏—Ä–µ–∫—Ç**: `/` (–≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)

#### D. PsychologistProtectedRoute

**–§–∞–π–ª**: `components/psychologist/PsychologistProtectedRoute.tsx`

**–ó–∞—â–∏—â–∞–µ—Ç**: `/psychologist/dashboard` (–ø–∞–Ω–µ–ª—å –ø—Å–∏—Ö–æ–ª–æ–≥–∞)  
**–ü—Ä–æ–≤–µ—Ä–∫–∞**: `isPsychologist === true`  
**–†–µ–¥–∏—Ä–µ–∫—Ç**: `/` (–≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)

---

## 5. Row-Level Security (RLS)

### 5.1. –ü—Ä–∏–Ω—Ü–∏–ø—ã RLS –≤ –ø—Ä–æ–µ–∫—Ç–µ

```
–°—Ç—Ä–∞—Ç–µ–≥–∏—è "Default Deny":
‚îú‚îÄ‚îÄ RLS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –í–°–ï–• —Ç–∞–±–ª–∏—Ü–∞—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ –ë–µ–∑ —è–≤–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø –ó–ê–ü–†–ï–©–ï–ù
‚îî‚îÄ‚îÄ –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (SELECT/INSERT/UPDATE/DELETE)
```

### 5.2. –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–∏—Ç–∏–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º

#### –¢–∞–±–ª–∏—Ü–∞: profiles

```sql
-- –í–∫–ª—é—á–µ–Ω–∏–µ RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

-- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏
CREATE POLICY "Admins can view all profiles"
  ON profiles FOR SELECT
  USING (is_admin() = true);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);

-- –ê–¥–º–∏–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –ª—é–±–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Admins can update all profiles"
  ON profiles FOR UPDATE
  USING (is_admin() = true);

-- DELETE –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤—Å–µ–º (—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ admin —Ñ—É–Ω–∫—Ü–∏—é)
```

#### –¢–∞–±–ª–∏—Ü–∞: mood_entries

```sql
ALTER TABLE mood_entries ENABLE ROW LEVEL SECURITY;

-- –°–≤–æ–∏ –∑–∞–ø–∏—Å–∏
CREATE POLICY "Users can view own mood entries"
  ON mood_entries FOR SELECT
  USING (auth.uid() = user_id);

-- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ
CREATE POLICY "Admins can view all mood entries"
  ON mood_entries FOR SELECT
  USING (is_admin() = true);

-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∏–¥–∏—Ç –≤—Å–µ
CREATE POLICY "Support can view all mood entries"
  ON mood_entries FOR SELECT
  USING (is_support() = true);

-- –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
CREATE POLICY "Users can insert own mood entries"
  ON mood_entries FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
CREATE POLICY "Users can update own mood entries"
  ON mood_entries FOR UPDATE
  USING (auth.uid() = user_id);

-- –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
CREATE POLICY "Users can delete own mood entries"
  ON mood_entries FOR DELETE
  USING (auth.uid() = user_id);
```

#### –¢–∞–±–ª–∏—Ü–∞: user_roles

```sql
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã —É–ø—Ä–∞–≤–ª—è—é—Ç —Ä–æ–ª—è–º–∏
CREATE POLICY "Only admins can manage roles"
  ON user_roles FOR ALL
  USING (is_admin() = true);
```

üîí **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞**: –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ù–ï –ú–û–ì–£–¢ –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏

#### –¢–∞–±–ª–∏—Ü–∞: support_tickets

```sql
ALTER TABLE support_tickets ENABLE ROW LEVEL SECURITY;

-- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞—é—Ç —Ç–∏–∫–µ—Ç—ã
CREATE POLICY "Authenticated users can create tickets"
  ON support_tickets FOR INSERT
  WITH CHECK (auth.uid() IS NOT NULL);

-- –°–≤–æ–∏ —Ç–∏–∫–µ—Ç—ã
CREATE POLICY "Users can view own tickets"
  ON support_tickets FOR SELECT
  USING (auth.uid() = user_id);

-- –ü–µ—Ä—Å–æ–Ω–∞–ª –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–∏–∫–µ—Ç—ã
CREATE POLICY "Staff can view all tickets"
  ON support_tickets FOR SELECT
  USING (is_admin() = true OR is_support() = true);

-- –ü–µ—Ä—Å–æ–Ω–∞–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–∫–µ—Ç—ã
CREATE POLICY "Staff can update tickets"
  ON support_tickets FOR UPDATE
  USING (is_admin() = true OR is_support() = true);

-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω —É–¥–∞–ª—è–µ—Ç —Ç–∏–∫–µ—Ç—ã
CREATE POLICY "Only admins can delete tickets"
  ON support_tickets FOR DELETE
  USING (is_admin() = true);
```

#### –¢–∞–±–ª–∏—Ü–∞: articles (–ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)

```sql
ALTER TABLE articles ENABLE ROW LEVEL SECURITY;

-- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ
CREATE POLICY "Anyone can view published articles"
  ON articles FOR SELECT
  USING (published = true OR is_admin() = true OR is_support() = true);

-- –ü–µ—Ä—Å–æ–Ω–∞–ª —Å–æ–∑–¥–∞–µ—Ç —Å—Ç–∞—Ç—å–∏
CREATE POLICY "Staff can create articles"
  ON articles FOR INSERT
  WITH CHECK (is_admin() = true OR is_support() = true);

-- –ü–µ—Ä—Å–æ–Ω–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—å–∏
CREATE POLICY "Staff can update articles"
  ON articles FOR UPDATE
  USING (is_admin() = true OR is_support() = true);

-- –ü–µ—Ä—Å–æ–Ω–∞–ª —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ç—å–∏
CREATE POLICY "Staff can delete articles"
  ON articles FOR DELETE
  USING (is_admin() = true OR is_support() = true);
```

#### –¢–∞–±–ª–∏—Ü–∞: psychologist_profiles

```sql
ALTER TABLE psychologist_profiles ENABLE ROW LEVEL SECURITY;

-- –°–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω
CREATE POLICY "Psychologists can view own profile"
  ON psychologist_profiles FOR SELECT
  USING (
    auth.uid() = user_id 
    OR has_role(auth.uid(), 'admin') 
    OR has_role(auth.uid(), 'psychologist')
  );

-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏
CREATE POLICY "Only admins can create psychologist profiles"
  ON psychologist_profiles FOR INSERT
  WITH CHECK (has_role(auth.uid(), 'admin'));

-- –°–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω
CREATE POLICY "Psychologists can update own profile"
  ON psychologist_profiles FOR UPDATE
  USING (
    auth.uid() = user_id 
    OR has_role(auth.uid(), 'admin')
  );
```

---

## 6. Edge Functions - –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞

### 6.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ Edge Functions

**–§–∞–π–ª**: `supabase/functions/_shared/auth.ts`

```typescript
async function verifyAdmin(req: Request): Promise<VerifyResult> {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Authorization header
  const authHeader = req.headers.get('Authorization');
  if (!authHeader) {
    return { errorResponse: new Response('Unauthorized', { status: 401 }) };
  }

  // 2. –°–æ–∑–¥–∞–Ω–∏–µ service client (Service Role Key)
  const serviceClient = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );

  // 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ header
  const token = authHeader.replace('Bearer ', '');

  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É
  const { data: { user }, error } = await serviceClient.auth.getUser(token);
  if (error || !user) {
    return { errorResponse: new Response('Unauthorized', { status: 401 }) };
  }

  // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ admin –≤ —Ç–∞–±–ª–∏—Ü–µ user_roles
  const { data: roleData, error: roleError } = await serviceClient
    .from('user_roles')
    .select('role')
    .eq('user_id', user.id)
    .eq('role', 'admin')
    .single();

  if (roleError || !roleData) {
    return { errorResponse: new Response('Forbidden', { status: 403 }) };
  }

  // 6. –£—Å–ø–µ—Ö - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º service client –∏ user
  return { errorResponse: null, serviceClient, user };
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö:**
- `get-users` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `update-user-status` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get-user-actions` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 7. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞

```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Browser as –ë—Ä–∞—É–∑–µ—Ä
    participant Router as React Router
    participant Auth as AuthContext
    participant Supabase as Supabase Auth
    participant DB as PostgreSQL (RLS)
    participant Edge as Edge Function

    User->>Browser: –ü—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ /admin/dashboard
    Browser->>Router: –ù–∞–≤–∏–≥–∞—Ü–∏—è
    Router->>Auth: –ü—Ä–æ–≤–µ—Ä–∫–∞ isAdmin

    alt –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ / –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
        Auth->>Supabase: getSession()
        Supabase-->>Auth: Session + JWT
        Auth->>Supabase: rpc('is_admin')
        Supabase->>DB: SELECT FROM user_roles WHERE user_id = auth.uid()
        DB-->>Supabase: role = 'admin' ?
        Supabase-->>Auth: boolean result
    end

    alt isAdmin = true
        Router->>Browser: –†–µ–Ω–¥–µ—Ä–∏—Ç AdminDashboard
        Browser->>Edge: GET /functions/get-users (with JWT)
        Edge->>Supabase: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        Supabase-->>Edge: User verified
        Edge->>DB: SELECT FROM user_roles WHERE role = 'admin'
        DB-->>Edge: –†–æ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
        Edge-->>Browser: –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    else isAdmin = false
        Router->>Browser: Navigate to="/"
        Browser-->>User: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    end
```

---

## 8. –ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º

| –¢–∞–±–ª–∏—Ü–∞ / –û–ø–µ—Ä–∞—Ü–∏—è | –ì–æ—Å—Ç—å | User | Psychologist | Support | Admin |
|-------------------|-------|------|--------------|---------|-------|
| **profiles** (SELECT own) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **profiles** (SELECT all) | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **profiles** (UPDATE own) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **profiles** (UPDATE all) | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **mood_entries** (own) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **mood_entries** (view all) | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **articles** (SELECT) | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **articles** (INSERT/UPDATE/DELETE) | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **support_tickets** (CREATE) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **support_tickets** (view own) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **support_tickets** (view all) | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **support_tickets** (UPDATE) | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **user_roles** (ALL) | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **psychologist_profiles** (own) | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ |
| **psychologist_availability** (own) | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ |

---

## 9. –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç–∞

### 9.1. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏

#### ‚úÖ Privilege Escalation (–ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)

**–ó–∞—â–∏—Ç–∞:**
- –†–æ–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `user_roles`
- RLS –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π –≤—Å–µ–º –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ SECURITY DEFINER —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω):**
```sql
-- –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å –Ω–∞ –∞–¥–º–∏–Ω–∞
UPDATE user_roles 
SET role = 'admin' 
WHERE user_id = auth.uid();

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: ERROR - insufficient privileges (RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç)
```

#### ‚úÖ Horizontal Privilege Escalation (–¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –¥–∞–Ω–Ω—ã–º)

**–ó–∞—â–∏—Ç–∞:**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç `auth.uid() = user_id`
- JWT —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è Supabase

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω):**
```sql
-- –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—É–∂–∏–µ –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞
SELECT * FROM mood_entries 
WHERE user_id = 'other-user-id';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (RLS —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç)
```

#### ‚úÖ SQL Injection

**–ó–∞—â–∏—Ç–∞:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Supabase Client (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- RLS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω):**
```typescript
// –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
const { data } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', userId); // –ë–µ–∑–æ–ø–∞—Å–Ω–æ

// –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
```

#### ‚úÖ JWT Token Manipulation

**–ó–∞—â–∏—Ç–∞:**
- –¢–æ–∫–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º Supabase
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ Edge Functions

#### ‚úÖ Client-Side Role Spoofing

**–ó–∞—â–∏—Ç–∞:**
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ñ–ª–∞–≥–∏ (`isAdmin`) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è UI
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ RLS/RPC

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Ç–æ–ª—å–∫–æ UI):
if (isAdmin) {
  // –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (+ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
const { data, error } = await supabase
  .from('users')
  .delete()
  .eq('id', userId);
// RLS –ø—Ä–æ–≤–µ—Ä–∏—Ç is_admin() –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```

### 9.2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```sql
-- Rate Limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞)
CREATE OR REPLACE FUNCTION check_comprehensive_rate_limit(
  identifier text,
  action_type text,
  max_attempts integer,
  window_minutes integer
) RETURNS boolean;

-- Security Event Logging (–∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π)
CREATE OR REPLACE FUNCTION log_security_event(
  event_type text,
  user_id uuid,
  details jsonb,
  ip_address text,
  user_agent text
) RETURNS void;

-- Admin Session Validation (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –∞–¥–º–∏–Ω–∞)
CREATE OR REPLACE FUNCTION validate_admin_session() RETURNS boolean;

-- Password Strength Validation (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è)
CREATE OR REPLACE FUNCTION validate_password_strength(password text) 
RETURNS boolean;
-- –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω—ã–µ, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
```

---

## 10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### ‚úÖ Best Practices (—Ç–µ–∫—É—â–∏–µ)

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É**
2. **RLS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏**
3. **SECURITY DEFINER —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π**
4. **JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**
5. **Service Role Key —Ç–æ–ª—å–∫–æ –≤ Edge Functions**
6. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ security events**

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å `volunteer`** (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
2. **Implement Multi-Factor Authentication (MFA)** –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
3. **Session Timeout** –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π (–∞–≤—Ç–æ–≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ N –º–∏–Ω—É—Ç)
4. **IP Whitelisting** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
5. **Audit Trail** –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
6. **Content Security Policy (CSP)** headers
7. **Rate Limiting –Ω–∞ API endpoints**

---

## 11. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞

### 11.1. –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

```sql
-- –ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ RLS
SELECT tablename 
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename NOT LIKE 'pg_%'
  AND tablename NOT IN (
    SELECT tablename 
    FROM pg_policies
  );

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç RLS)
```

#### 2. –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ö–æ–¥–∞ RLS (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)

```sql
-- –í–æ–π—Ç–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
-- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:
UPDATE user_roles 
SET role = 'admin' 
WHERE user_id = auth.uid();

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 
-- ERROR: new row violates row-level security policy
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤

```bash
# –û—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
# –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ /admin/dashboard
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /
```

#### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Edge Functions

```bash
curl -X POST \
  https://your-project.supabase.co/functions/v1/get-users \
  -H "Authorization: Bearer INVALID_TOKEN"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 401 Unauthorized
```

#### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ XSS –∑–∞—â–∏—Ç—ã

```typescript
// –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–≤–µ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º—É:
<script>alert('XSS')</script>

// –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 
// –¢–µ–∫—Å—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω, —Å–∫—Ä–∏–ø—Ç –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
```

### 11.2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```typescript
// tests/security.test.ts

describe('Security Tests', () => {
  it('should block unauthorized access to admin routes', async () => {
    const response = await fetch('/admin/dashboard');
    expect(response).toRedirect('/');
  });

  it('should verify RLS on mood_entries', async () => {
    // –í–æ–π—Ç–∏ –∫–∞–∫ user1
    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏ user2
    const { data } = await supabase
      .from('mood_entries')
      .select('*')
      .eq('user_id', 'user2-id');
    
    expect(data).toHaveLength(0);
  });

  it('should prevent role escalation', async () => {
    const { error } = await supabase
      .from('user_roles')
      .update({ role: 'admin' })
      .eq('user_id', currentUserId);
    
    expect(error).toBeDefined();
  });
});
```

---

## 12. –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ê—É–¥–∏—Ç —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- [ ] –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ security events

### –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (npm audit)
- [ ] –†–µ–≤—å—é RLS –ø–æ–ª–∏—Ç–∏–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è

### –ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –†–µ–≤—å—é –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- [ ] –¢—Ä–µ–Ω–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ï—Å–ª–∏ –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ:

- **Email**: security@ptsr-expert.ru
- **Telegram**: @ptsr_security
- **–¢–µ–ª–µ—Ñ–æ–Ω**: +7 (800) 123-45-67

**–ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö –ø—É–±–ª–∏—á–Ω–æ!**

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Next.js Security Headers](https://nextjs.org/docs/advanced-features/security-headers)

---

**–î–æ–∫—É–º–µ–Ω—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 12 –Ω–æ—è–±—Ä—è 2025**

¬© 2024 –ü–¢–°–† –≠–∫—Å–ø–µ—Ä—Ç. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.

