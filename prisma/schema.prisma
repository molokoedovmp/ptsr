generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  fullName            String?              @map("full_name")
  phone               String?
  avatarUrl           String?              @map("avatar_url")
  dateOfBirth         DateTime?            @map("date_of_birth")
  gender              Gender               @default(NOT_SPECIFIED)
  country             String               @default("Россия")
  city                String?
  worldview           String?
  emailVerified       DateTime?            @map("email_verified")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  roles               UserRole[]
  accounts            Account[]
  articles            Article[]            @relation("ArticleAuthor")
  enrollments         CourseEnrollment[]
  diaryEntries        DiaryEntry[]
  moodEntries         MoodEntry[]
  psychologistProfile PsychologistProfile?
  sessions            Session[]
  supportTickets      SupportTicket[]
  transactions        Transaction[]
  activityLogs        ActivityLog[]        // ← Добавлено
  anxietyTestResults  AnxietyTestResult[]
  articleFeedbacks    ArticleFeedback[]
  articleBookmarks    ArticleBookmark[]
  consultationBookings ConsultationSlot[]  @relation("UserConsultationBookings")

  @@map("users")
}


model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model MoodEntry {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  moodLevel Int      @map("mood_level")
  moodType  String?  @map("mood_type")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("mood_entries")
}

model DiaryEntry {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  title        String
  content      String
  activityType String?  @map("activity_type")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("diary_entries")
}

model SupportTicket {
  id         String         @id @default(cuid())
  userId     String         @map("user_id")
  subject    String
  message    String
  status     TicketStatus   @default(OPEN)
  priority   TicketPriority @default(MEDIUM)
  assignedTo String?        @map("assigned_to")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("support_tickets")
}

model PsychologistProfile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  specialization  String[]
  experienceYears Int      @map("experience_years")
  education       String
  bio             String?
  price           Int
  languages       String[] @default(["Русский"])
  verified        Boolean  @default(false)
  available       Boolean  @default(true)
  rating          Float?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  slots           ConsultationSlot[]

  @@map("psychologist_profiles")
}

model PsychologistApplication {
  id              String             @id @default(cuid())
  fullName        String
  email           String
  phone           String
  specialization  String
  experienceYears Int      @map("experience_years")
  education       String
  inviteCode      String?
  message         String?
  activationToken String?            @map("activation_token")
  activationTokenExpires DateTime?   @map("activation_token_expires")
  activated       Boolean            @default(false)
  activatedAt     DateTime?          @map("activated_at")
  status          ApplicationStatus @default(PENDING)
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@unique([email, inviteCode])
  @@map("psychologist_applications")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVATED
}

model ConsultationSlot {
  id              String      @id @default(cuid())
  psychologistId  String      @map("psychologist_id")
  startTime       DateTime    @map("start_time")
  endTime         DateTime    @map("end_time")
  status          SlotStatus  @default(AVAILABLE)
  clientName      String?     @map("client_name")
  clientEmail     String?     @map("client_email")
  clientPhone     String?     @map("client_phone")
  clientMessage   String?     @map("client_message")
  bookedByUserId  String?     @map("booked_by_user_id")
  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  psychologist    PsychologistProfile @relation(fields: [psychologistId], references: [id], onDelete: Cascade)
  bookedByUser    User?       @relation("UserConsultationBookings", fields: [bookedByUserId], references: [id], onDelete: SetNull)

  @@index([psychologistId, startTime])
  @@index([bookedByUserId])
  @@map("consultation_slots")
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  COMPLETED
  CANCELLED
}

model Article {
  id         String   @id @default(cuid())
  title      String
  slug       String   @unique
  content    String
  excerpt    String
  coverImage String?  @map("cover_image")
  authorId   String   @map("author_id")
  category   String
  displayAuthor String? @map("display_author")
  status     ArticleStatus @default(APPROVED)
  moderationComment String? @map("moderation_comment")
  verifiedAt DateTime? @map("verified_at")
  readingMinutes Int? @map("reading_minutes")
  sourceTitle String? @map("source_title")
  sourceUrl   String? @map("source_url")
  publishedAt DateTime? @map("published_at")
  faq         Json?    @map("faq_items")
  tags       String[]
  published  Boolean  @default(false)
  viewCount  Int      @default(0) @map("view_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  author     User     @relation("ArticleAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  feedback   ArticleFeedback[]
  bookmarks  ArticleBookmark[]

  @@index([published, createdAt])
  @@index([slug])
  @@map("articles")
}

model ArticleFeedback {
  id        String   @id @default(cuid())
  articleId String   @map("article_id")
  userId    String?  @map("user_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([articleId])
  @@unique([articleId, userId])
  @@map("article_feedback")
}

model ArticleBookmark {
  id        String   @id @default(cuid())
  articleId String   @map("article_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([userId, createdAt])
  @@map("article_bookmarks")
}

model ArticleSubscription {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  @@map("article_subscriptions")
}

enum ArticleStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

model Video {
  id           String   @id @default(cuid())
  title        String
  description  String
  videoUrl     String   @map("video_url")
  thumbnailUrl String?  @map("thumbnail_url")
  duration     Int?
  category     String
  tags         String[]
  published    Boolean  @default(false)
  viewCount    Int      @default(0) @map("view_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([published, createdAt])
  @@map("videos")
}

model Course {
  id              String             @id @default(cuid())
  title           String
  slug            String             @unique
  description     String
  fullDescription String             @map("full_description")
  price           Int
  currency        String             @default("RUB")
  durationWeeks   Int                @map("duration_weeks")
  level           String
  coverImage      String?            @map("cover_image")
  published       Boolean            @default(false)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  enrollments     CourseEnrollment[]
  modules         CourseModule[]

  @@index([published, slug])
  @@map("courses")
}

model CourseModule {
  id          String   @id @default(cuid())
  courseId    String   @map("course_id")
  title       String
  description String
  content     String
  orderIndex  Int      @map("order_index")
  duration    Int?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([courseId, orderIndex])
  @@map("course_modules")
}

model Lesson {
  id             String           @id @default(cuid())
  moduleId       String           @map("module_id")
  title          String
  description    String?
  content        String
  videoUrl       String?          @map("video_url")
  duration       Int?
  orderIndex     Int              @map("order_index")
  isFree         Boolean          @default(false) @map("is_free")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  lessonProgress LessonProgress[]
  module         CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId, orderIndex])
  @@map("lessons")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  lessonId    String    @map("lesson_id")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, completed])
  @@map("lesson_progress")
}

model CourseEnrollment {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  courseId       String    @map("course_id")
  progress       Int       @default(0)
  completed      Boolean   @default(false)
  completedAt    DateTime? @map("completed_at")
  certificateUrl String?   @map("certificate_url")
  enrolledAt     DateTime  @default(now()) @map("enrolled_at")
  course         Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, completed])
  @@map("course_enrollments")
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int
  currency    String   @default("RUB")
  description String
  type        String
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("transactions")
}

model VisitorAnalytics {
  id           String   @id @default(cuid())
  sessionId    String   @map("session_id")
  userId       String?  @map("user_id")
  pagePath     String   @map("page_path")
  pageTitle    String?  @map("page_title")
  referrer     String?
  country      String?
  countryCode  String?  @map("country_code")
  city         String?
  region       String?
  device       String?
  os           String?
  browser      String?
  screenWidth  Int?     @map("screen_width")
  screenHeight Int?     @map("screen_height")
  language     String?
  timezone     String?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  timestamp    DateTime @default(now())
  duration     Int?

  @@index([userId, timestamp])
  @@index([pagePath, timestamp])
  @@index([country, timestamp])
  @@index([sessionId])
  @@map("visitor_analytics")
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("activity_log")
}


enum UserRole {
  ADMIN
  SUPPORT
  PSYCHOLOGIST
  VOLUNTEER
  USER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}
model AnxietyTestResult {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  testSlug    String   @map("test_slug")
  testTitle   String   @map("test_title")
  score       Int
  maxScore    Int      @map("max_score")
  severity    String
  answers     Json?
  completedAt DateTime @default(now()) @map("completed_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, completedAt])
  @@map("anxiety_test_results")
}
