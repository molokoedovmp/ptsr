// Prisma Schema для ПТСР Эксперт

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum для ролей пользователей
enum UserRole {
  ADMIN
  SUPPORT
  PSYCHOLOGIST
  VOLUNTEER
  USER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

// Модель пользователя
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  fullName      String?   @map("full_name")
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  dateOfBirth   DateTime? @map("date_of_birth")
  gender        Gender    @default(NOT_SPECIFIED)
  country       String    @default("Россия")
  city          String?
  emailVerified DateTime? @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Отношения
  roles               UserRole[]
  accounts            Account[]
  sessions            Session[]
  moodEntries         MoodEntry[]
  diaryEntries        DiaryEntry[]
  supportTickets      SupportTicket[]
  psychologistProfile PsychologistProfile?
  enrollments         CourseEnrollment[]
  transactions        Transaction[]
  articles            Article[]            @relation("ArticleAuthor")

  @@map("users")
}

// Аккаунты для NextAuth
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// Сессии для NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Токены верификации
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Записи дневника настроения
model MoodEntry {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  moodLevel  Int      @map("mood_level") // 1-5
  moodType   String?  @map("mood_type")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("mood_entries")
}

// Записи дневника активности
model DiaryEntry {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  title        String
  content      String   @db.Text
  activityType String?  @map("activity_type")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("diary_entries")
}

// Тикеты поддержки
model SupportTicket {
  id         String         @id @default(cuid())
  userId     String         @map("user_id")
  subject    String
  message    String         @db.Text
  status     TicketStatus   @default(OPEN)
  priority   TicketPriority @default(MEDIUM)
  assignedTo String?        @map("assigned_to")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("support_tickets")
}

// Профиль психолога
model PsychologistProfile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  specialization  String[] // массив специализаций
  experienceYears Int      @map("experience_years")
  education       String
  bio             String?  @db.Text
  price           Int      // цена за консультацию в рублях
  languages       String[] @default(["Русский"])
  verified        Boolean  @default(false)
  available       Boolean  @default(true)
  rating          Float?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("psychologist_profiles")
}

// Статьи
model Article {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String
  coverImage  String?  @map("cover_image")
  authorId    String   @map("author_id")
  category    String
  tags        String[]
  published   Boolean  @default(false)
  viewCount   Int      @default(0) @map("view_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  author User @relation("ArticleAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([published, createdAt])
  @@index([slug])
  @@map("articles")
}

// Видео
model Video {
  id           String   @id @default(cuid())
  title        String
  description  String   @db.Text
  videoUrl     String   @map("video_url")
  thumbnailUrl String?  @map("thumbnail_url")
  duration     Int?     // в секундах
  category     String
  tags         String[]
  published    Boolean  @default(false)
  viewCount    Int      @default(0) @map("view_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([published, createdAt])
  @@map("videos")
}

// Программы/Курсы
model Course {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String
  fullDescription String   @map("full_description") @db.Text
  price           Int      // цена в рублях
  currency        String   @default("RUB")
  durationWeeks   Int      @map("duration_weeks")
  level           String   // Начальный, Средний, Продвинутый
  coverImage      String?  @map("cover_image")
  published       Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  modules     CourseModule[]
  enrollments CourseEnrollment[]

  @@index([published, slug])
  @@map("courses")
}

// Модули курса
model CourseModule {
  id          String   @id @default(cuid())
  courseId    String   @map("course_id")
  title       String
  description String   @db.Text
  content     String   @db.Text
  orderIndex  Int      @map("order_index")
  duration    Int?     // в минутах
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId, orderIndex])
  @@map("course_modules")
}

// Уроки в модулях
model Lesson {
  id          String   @id @default(cuid())
  moduleId    String   @map("module_id")
  title       String
  description String?  @db.Text
  content     String   @db.Text // JSON или HTML контент урока
  videoUrl    String?  @map("video_url")
  duration    Int?     // длительность в минутах
  orderIndex  Int      @map("order_index")
  isFree      Boolean  @default(false) @map("is_free") // бесплатный урок для предпросмотра
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  module           CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessonProgress   LessonProgress[]

  @@index([moduleId, orderIndex])
  @@map("lessons")
}

// Прогресс по урокам
model LessonProgress {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  lessonId    String    @map("lesson_id")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, completed])
  @@map("lesson_progress")
}

// Записи на курсы
model CourseEnrollment {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  courseId     String    @map("course_id")
  progress     Int       @default(0) // процент прохождения
  completed    Boolean   @default(false)
  completedAt  DateTime? @map("completed_at")
  certificateUrl String? @map("certificate_url")
  enrolledAt   DateTime  @default(now()) @map("enrolled_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, completed])
  @@map("course_enrollments")
}

// Транзакции
model Transaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int      // в копейках (для точности)
  currency    String   @default("RUB")
  description String
  type        String   // payment, refund, donation
  status      String   // pending, completed, failed
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("transactions")
}

// Аналитика посещений
model VisitorAnalytics {
  id            String   @id @default(cuid())
  sessionId     String   @map("session_id")
  userId        String?  @map("user_id") // null если анонимный пользователь
  pagePath      String   @map("page_path")
  pageTitle     String?  @map("page_title")
  referrer      String?
  
  // Геолокация
  country       String?
  countryCode   String?  @map("country_code")
  city          String?
  region        String?
  
  // Устройство и браузер
  device        String?  // mobile, tablet, desktop
  os            String?  // операционная система
  browser       String?  // браузер
  screenWidth   Int?     @map("screen_width")
  screenHeight  Int?     @map("screen_height")
  
  // Язык и временная зона
  language      String?
  timezone      String?
  
  // IP и User Agent
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent") @db.Text
  
  // Временные метрики
  timestamp     DateTime @default(now())
  duration      Int?     // время на странице в секундах
  
  @@index([userId, timestamp])
  @@index([pagePath, timestamp])
  @@index([country, timestamp])
  @@index([sessionId])
  @@map("visitor_analytics")
}



